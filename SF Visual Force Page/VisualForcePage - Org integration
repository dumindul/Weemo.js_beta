<apex:page showHeader="false" sidebar="false">
<script type='text/javascript' src='https://c.la2c1.salesforceliveagent.com/content/g/js/29.0/deployment.js'></script>
<script type='text/javascript' src="/support/console/29.0/integration.js"></script>
<script src="/soap/ajax/19.0/connection.js" type="text/javascript"></script>
<script src="https://download-ppr.weemo.com/js/webappid/MyAppIdentifier" ></script>
<link rel="stylesheet" type="text/css" href="https://demo.weemo.com/css/demosalesforce.css"></link>
<div id="clickToCall" onclick="getDetailsPrimaryTabId();return false;" style="text-align: center;">
  <a>Click here to Video Chat with the Visitor</a>
  <div id="labelToCall"></div>
</div>
<script type="text/javascript">
     
  var WebAppIdentifier = "MyAppIdentifier";

  var modal;
  var tabToFindUser;
  weemo = new Weemo(WebAppIdentifier,"{!$User.Username}","internal","",1,'{!$User.FirstName} {!$User.LastName}'); 
  weemo.onConnectionHandler = function(message, code) {
    if(window.console)
      console.log("Connection Handler : " + message + ' ' + code);
    
    switch(message) {
      case 'connectedWebRTC':
        weemo.authenticate();
        break;
      case 'sipOk':
        break;
    }
  }

  weemo.initialize();

var eventHandler = function (result) {
    tabToFindUser = result.id.toLowerCase();
    sforce.console.chat.getDetailsByPrimaryTabId(tabToFindUser, setVisitorName);
};

function getDetailsPrimaryTabId() {
    var primaryTabId = tabToFindUser;
    sforce.console.chat.getDetailsByPrimaryTabId(primaryTabId, getDetailsSuccess);
}

function getDetailsSuccess(result) {
    //Report whether accepting the chat was succesful
    if (result.success == true) {
        console.log(result);
        visitorId = result.details.customDetails[0].value.toLowerCase();
        weemo.createCall(visitorId, "internal", "Visitor");
    } else {
        console.log('Getting the details was not Succesful');
    }
};

function setVisitorName(result) {
    if (result.success == true) {
        console.log(result);
        visitorId = result.details.customDetails[0].value.toLowerCase();
    } else {
        console.log('Getting the details was not Succesful');
    }
};

function toogleImage(){
  $("#labelToCall").html('Video chat invite sent');
  setTimeout(function(){$("#labelToCall").html('');},14000);
}

sforce.console.onFocusedPrimaryTab(eventHandler);
</script>

</apex:page>
